<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Croquis Pro - Contraste Alto</title>
    <style>
        :root { --reservado: #ff4757; --borde: #000000; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #f0f2f5; margin: 0; padding: 10px; }
        
        /* Panel Superior */
        .menu-top { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; background: white; padding: 12px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 10px; }
        
        button { padding: 12px; border: none; border-radius: 6px; cursor: pointer; color: white; font-weight: bold; font-size: 13px; }
        .btn-add { background: #2f3542; }
        .btn-share { background: #25D366; }
        .btn-import { background: #ffa502; }

        /* Lienzo BLANCO */
        .canvas-wrapper { width: 100%; height: 65vh; overflow: auto; border: 2px solid #ccc; border-radius: 8px; }
        #canvas { 
            background: #ffffff; /* FONDO BLANCO */
            position: relative; 
            background-image: radial-gradient(#e0e0e0 1px, transparent 1px); background-size: 30px 30px; 
        }

        /* Mesas BLANCAS con borde NEGRO */
        .elemento {
            position: absolute; display: flex; flex-direction: column; align-items: center; justify-content: center;
            border: 3px solid var(--borde); /* Borde Negro Grueso */
            background: #ffffff; /* Fondo Blanco */
            color: #000000; /* Texto Negro */
            min-width: 60px; min-height: 60px;
            touch-action: none;
            box-sizing: border-box;
            font-weight: bold;
        }

        /* Cuando se reservan: ROJO */
        .ocupada { 
            background: var(--reservado) !important; 
            color: white !important; 
            border-color: #000 !important;
        }

        /* Controles para M√≥vil */
        .controles-mini { position: absolute; top: -40px; display: flex; gap: 8px; }
        .btn-mini { width: 30px; height: 30px; border-radius: 50%; border: 2px solid black; font-size: 14px; display: flex; align-items: center; justify-content: center; color: black; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

        .resizer { width: 20px; height: 20px; background: #000; position: absolute; right: 0; bottom: 0; border: 2px solid #fff; }

        @media print {
            .menu-top, .controles-mini, .resizer { display: none !important; }
            body { padding: 0; background: white; }
            .canvas-wrapper { overflow: visible; border: none; }
            #canvas { border: 1px solid #000; zoom: 80%; }
        }
    </style>
</head>
<body>

    <div class="menu-top">
        <button class="btn-add" onclick="addElement('mesa')">+ Mesa</button>
        <button class="btn-add" onclick="addElement('pantalla')">+ TV / Objeto</button>
        <button class="btn-share" onclick="compartirWhatsApp()">üì≤ Enviar por WhatsApp</button>
        <button class="btn-import" onclick="importarCodigo()">üì• Pegar C√≥digo</button>
    </div>

    <div class="canvas-wrapper">
        <div id="canvas" style="width: 1500px; height: 1000px;"></div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        let storageKey = 'croquis_v5_final';

        window.onload = () => { load(); };

        function save() { localStorage.setItem(storageKey, canvas.innerHTML); }
        function load() {
            const data = localStorage.getItem(storageKey);
            if (data) { canvas.innerHTML = data; document.querySelectorAll('.elemento').forEach(attachEvents); }
        }

        function addElement(tipo) {
            const el = document.createElement('div');
            el.className = `elemento ${tipo}`;
            el.style.left = '100px'; el.style.top = '100px';
            el.setAttribute('data-rotation', '0');
            
            el.innerHTML = `
                <div class="controles-mini">
                    <div class="btn-mini" onclick="rotateEl(this.parentElement.parentElement)">üîÑ</div>
                    <div class="btn-mini" onclick="editEl(this.parentElement.parentElement)">‚úèÔ∏è</div>
                    <div class="btn-mini" style="background:#ff4757; color:white;" onclick="this.parentElement.parentElement.remove(); save();">‚úï</div>
                </div>
                <b>Mesa</b><div class="cli" style="font-size:11px; margin-top:5px;">Libre</div>
                <div class="resizer"></div>
            `;
            canvas.appendChild(el);
            attachEvents(el);
            save();
        }

        function attachEvents(el) {
            let active = false, initialX, initialY;

            // Arrastre t√°ctil/rat√≥n
            el.addEventListener("touchstart", dragStart, {passive: false});
            el.addEventListener("mousedown", dragStart);
            document.addEventListener("touchend", dragEnd);
            document.addEventListener("mouseup", dragEnd);
            document.addEventListener("touchmove", drag, {passive: false});
            document.addEventListener("mousemove", drag);

            function dragStart(e) {
                if (e.target.classList.contains('btn-mini') || e.target.classList.contains('resizer')) return;
                let event = e.type === "touchstart" ? e.touches[0] : e;
                initialX = event.clientX - el.offsetLeft;
                initialY = event.clientY - el.offsetTop;
                active = true;
            }

            function drag(e) {
                if (active) {
                    if(e.type === "touchmove") e.preventDefault();
                    let event = e.type === "touchmove" ? e.touches[0] : e;
                    el.style.left = (event.clientX - initialX) + "px";
                    el.style.top = (event.clientY - initialY) + "px";
                }
            }
            function dragEnd() { active = false; save(); }

            // Redimensionar
            const r = el.querySelector('.resizer');
            r.onmousedown = r.ontouchstart = (e) => {
                e.stopPropagation();
                e.preventDefault();
                const startX = e.type === "touchstart" ? e.touches[0].clientX : e.clientX;
                const startY = e.type === "touchstart" ? e.touches[0].clientY : e.clientY;
                const startW = el.offsetWidth;
                const startH = el.offsetHeight;

                document.onmousemove = document.ontouchmove = (ev) => {
                    const curX = ev.type === "touchmove" ? ev.touches[0].clientX : ev.clientX;
                    const curY = ev.type === "touchmove" ? ev.touches[0].clientY : ev.clientY;
                    el.style.width = (startW + (curX - startX)) + "px";
                    el.style.height = (startH + (curY - startY)) + "px";
                };
                document.onmouseup = document.ontouchend = () => { document.onmousemove = null; document.ontouchmove = null; save(); };
            };
        }

        function rotateEl(el) {
            let rot = (parseInt(el.getAttribute('data-rotation') || 0) + 45) % 360;
            el.style.transform = `rotate(${rot}deg)`;
            el.setAttribute('data-rotation', rot);
            save();
        }

        function editEl(el) {
            const n = prompt("Nombre/N√∫mero de Mesa:", el.querySelector('b').innerText);
            const c = prompt("Nombre del Cliente (Vac√≠o para liberar):");
            if(n !== null) el.querySelector('b').innerText = n;
            const cli = el.querySelector('.cli');
            if(c && c.trim() !== "") {
                cli.innerText = c;
                el.classList.add('ocupada');
            } else {
                cli.innerText = "Libre";
                el.classList.remove('ocupada');
            }
            save();
        }

        function compartirWhatsApp() {
            const codigo = btoa(unescape(encodeURIComponent(canvas.innerHTML))); 
            const url = "https://wa.me/?text=" + encodeURIComponent("Copia este c√≥digo de croquis y p√©galo en la App:\n\n" + codigo);
            window.open(url, '_blank');
        }

        function importarCodigo() {
            const codigo = prompt("Pega el c√≥digo aqu√≠:");
            if(codigo) {
                try {
                    canvas.innerHTML = decodeURIComponent(escape(atob(codigo)));
                    document.querySelectorAll('.elemento').forEach(attachEvents);
                    save();
                } catch(e) { alert("Error al importar el c√≥digo."); }
            }
        }
    </script>
</body>
</html>
