<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Croquis Movil Compartible</title>
    <style>
        :root { --primary: #2980b9; --dark: #1a1a1a; }
        body { font-family: sans-serif; background: #d1d8e0; margin: 0; padding: 10px; overflow-x: hidden; }
        
        .menu-top { display: flex; flex-wrap: wrap; gap: 5px; justify-content: center; background: white; padding: 10px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 10px; }
        
        button { padding: 10px; border: none; border-radius: 5px; cursor: pointer; color: white; font-weight: bold; font-size: 12px; }
        .btn-add { background: var(--dark); }
        .btn-share { background: #25D366; } /* WhatsApp Color */
        .btn-import { background: #f39c12; }

        .canvas-wrapper { width: 100%; height: 60vh; overflow: auto; border: 2px solid #777; background: #999; position: relative; }
        #canvas { background: white; position: relative; background-image: radial-gradient(#ccc 1px, transparent 1px); background-size: 20px 20px; }

        .elemento {
            position: absolute; display: flex; flex-direction: column; align-items: center; justify-content: center;
            border: 2px solid #000; background: #2c3e50; color: white; min-width: 60px; min-height: 60px;
            touch-action: none; /* Crucial para m贸vil */
        }
        .ocupada { background: #000 !important; border: 3px double white !important; }

        /* Controles flotantes para m贸vil */
        .controles-mini { position: absolute; top: -35px; display: flex; gap: 5px; }
        .btn-mini { width: 25px; height: 25px; border-radius: 50%; border: 1px solid black; font-size: 10px; display: flex; align-items: center; justify-content: center; color: black; background: white; }

        .resizer { width: 20px; height: 20px; background: white; position: absolute; right: 0; bottom: 0; border: 1px solid #000; }

        @media print { .menu-top, .controles-mini, .resizer { display: none !important; } }
    </style>
</head>
<body>

    <div class="menu-top">
        <button class="btn-add" onclick="addElement('mesa')">+ Mesa</button>
        <button class="btn-add" onclick="addElement('pantalla')">+ TV</button>
        <button class="btn-share" onclick="compartirWhatsApp()"> Enviar por WhatsApp</button>
        <button class="btn-import" onclick="importarCodigo()"> Pegar C贸digo</button>
    </div>

    <div class="canvas-wrapper">
        <div id="canvas" style="width: 1000px; height: 800px;"></div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        let salonId = 'movil_v1';

        window.onload = () => { load(); };

        function save() { localStorage.setItem(salonId, canvas.innerHTML); }
        function load() {
            const data = localStorage.getItem(salonId);
            if (data) { canvas.innerHTML = data; document.querySelectorAll('.elemento').forEach(attachEvents); }
        }

        function addElement(tipo) {
            const el = document.createElement('div');
            el.className = `elemento ${tipo}`;
            el.style.left = '50px'; el.style.top = '50px';
            el.setAttribute('data-rotation', '0');
            
            // Estructura con controles para m贸vil
            el.innerHTML = `
                <div class="controles-mini">
                    <div class="btn-mini" onclick="rotateEl(this.parentElement.parentElement)"></div>
                    <div class="btn-mini" onclick="editEl(this.parentElement.parentElement)">锔</div>
                    <div class="btn-mini" style="background:#ff7675" onclick="this.parentElement.parentElement.remove(); save();">X</div>
                </div>
                <b>Mesa</b><div class="cli" style="font-size:10px">Libre</div>
                <div class="resizer"></div>
            `;
            canvas.appendChild(el);
            attachEvents(el);
            save();
        }

        function attachEvents(el) {
            let active = false, currentX, currentY, initialX, initialY, xOffset = 0, yOffset = 0;

            // Arrastre para t谩ctil y mouse
            el.addEventListener("touchstart", dragStart, false);
            el.addEventListener("mousedown", dragStart, false);
            document.addEventListener("touchend", dragEnd, false);
            document.addEventListener("mouseup", dragEnd, false);
            document.addEventListener("touchmove", drag, false);
            document.addEventListener("mousemove", drag, false);

            function dragStart(e) {
                if (e.target.classList.contains('btn-mini') || e.target.classList.contains('resizer')) return;
                let event = e.type === "touchstart" ? e.touches[0] : e;
                initialX = event.clientX - el.offsetLeft;
                initialY = event.clientY - el.offsetTop;
                active = true;
            }

            function drag(e) {
                if (active) {
                    e.preventDefault();
                    let event = e.type === "touchmove" ? e.touches[0] : e;
                    el.style.left = (event.clientX - initialX) + "px";
                    el.style.top = (event.clientY - initialY) + "px";
                }
            }
            function dragEnd() { active = false; save(); }

            // L贸gica de Redimensionar (simplificada para t谩ctil)
            const r = el.querySelector('.resizer');
            r.onmousedown = r.ontouchstart = (e) => {
                e.stopPropagation();
                const startX = e.type === "touchstart" ? e.touches[0].clientX : e.clientX;
                const startW = el.offsetWidth;
                document.onmousemove = document.ontouchmove = (ev) => {
                    const moveX = ev.type === "touchmove" ? ev.touches[0].clientX : ev.clientX;
                    el.style.width = (startW + (moveX - startX)) + "px";
                };
                document.onmouseup = document.ontouchend = () => { document.onmousemove = null; document.ontouchmove = null; save(); };
            };
        }

        function rotateEl(el) {
            let rot = (parseInt(el.getAttribute('data-rotation') || 0) + 45) % 360;
            el.style.transform = `rotate(${rot}deg)`;
            el.setAttribute('data-rotation', rot);
            save();
        }

        function editEl(el) {
            const n = prompt("Nombre:", el.querySelector('b').innerText);
            const c = prompt("Cliente:");
            if(n) el.querySelector('b').innerText = n;
            const cli = el.querySelector('.cli');
            if(c) { cli.innerText = c; el.classList.add('ocupada'); }
            else { cli.innerText = "Libre"; el.classList.remove('ocupada'); }
            save();
        }

        // COMPARTIR
        function compartirWhatsApp() {
            const codigo = btoa(canvas.innerHTML); // Encripta el dise帽o en un c贸digo corto
            const mensaje = encodeURIComponent("Hola, este es el croquis del sal贸n. Copia este c贸digo y p茅galo en el gestor: \n\n" + codigo);
            window.open(`https://wa.me/?text=${mensaje}`, '_blank');
        }

        function importarCodigo() {
            const codigo = prompt("Pega el c贸digo que te enviaron:");
            if(codigo) {
                try {
                    canvas.innerHTML = atob(codigo);
                    document.querySelectorAll('.elemento').forEach(attachEvents);
                    save();
                } catch(e) { alert("C贸digo no v谩lido"); }
            }
        }
    </script>
</body>
</html>